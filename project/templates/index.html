{% extends "base.html" %}
{% block title %}Discover ‚Äî Event Calendar{% endblock %}

{% block content %}
<style>
    /* --- COLOR & CONTRAST OVERRIDES --- */
    .text-gray-300 {
        color: #cbd5e1 !important;
    }

    .text-gray-400 {
        color: #94a3b8 !important;
    }

    /* Search Bar Contrast */
    .control-deck {
        background: rgba(30, 41, 59, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 1.5rem;
    }

    .search-input-group {
        background-color: #020617;
        border: 1px solid #334155;
        border-radius: 50px;
    }

    .search-input-group input {
        color: #fff !important;
        font-weight: 500;
    }

    .search-input-group input::placeholder {
        color: #64748b;
    }

    /* Segmented Control */
    .segmented-btn {
        color: #94a3b8;
    }

    .segmented-btn:hover {
        color: #fff;
    }

    .segmented-btn.active {
        background-color: #334155;
        color: #fff;
        font-weight: 600;
    }

    /* --- SCROLLABLE CATEGORIES FIX --- */
    .category-scroll-wrapper {
        display: flex;
        /* Enforce flexbox */
        flex-wrap: nowrap;
        /* Prevent wrapping to next line */
        overflow-x: auto;
        /* Allow horizontal scroll */
        -webkit-overflow-scrolling: touch;
        /* Smooth scroll on mobile */
        gap: 0.5rem;
        /* Space between buttons */
        padding-bottom: 8px;
        /* Space for scrollbar */
        margin-bottom: 0px;
        white-space: nowrap;
        /* Ensure text doesn't wrap */
        width: 100%;
        /* Full width of parent */
    }

    /* Custom Scrollbar Styling (Thin & Dark) */
    .category-scroll-wrapper::-webkit-scrollbar {
        height: 6px;
        /* Visible but thin height */
        display: block;
        /* Ensure it's visible on desktop */
    }

    .category-scroll-wrapper::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        /* Very subtle track */
        border-radius: 3px;
    }

    .category-scroll-wrapper::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        /* Subtle thumb */
        border-radius: 3px;
    }

    .category-scroll-wrapper::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.4);
        /* Brighter on hover */
    }

    /* Stats & Guide */
    .source-guide {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 12px;
    }

    .source-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-radius: 8px;
        transition: background 0.2s;
    }

    .source-item:hover {
        background: rgba(255, 255, 255, 0.03);
    }

    .stat-badge {
        font-size: 0.75rem;
        font-weight: 700;
        padding: 4px 10px;
        border-radius: 12px;
        margin-left: auto;
    }

    /* Cards */
    .event-card {
        background-color: #1e293b;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .event-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5);
        border-color: rgba(59, 130, 246, 0.5);
    }

    .badge-float {
        position: absolute;
        top: 12px;
        right: 12px;
        font-size: 0.7rem;
        font-weight: 700;
        padding: 6px 12px;
        border-radius: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        z-index: 2;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge-official {
        background-color: #22d3ee;
        color: #0f172a;
    }

    .badge-community {
        background-color: #4ade80;
        color: #0f172a;
    }
</style>

<div class="container pt-5 pb-4">
    <div class="row align-items-end mb-4">
        <div class="col-lg-7">
            <h2 class="fw-bold text-white mb-1">Explore Events</h2>
            <p class="text-gray-400 mb-0">Discover Singapore's vibrant art scene.</p>
        </div>
        <div class="col-lg-5 text-lg-end">
            <div class="d-inline-block text-end">
                <span class="text-gray-400 small text-uppercase fw-bold" style="letter-spacing: 1px;">Total
                    Events</span>
                <div class="display-6 fw-bold text-white lh-1" id="stat-total">0</div>
            </div>
        </div>
    </div>

    <div class="source-guide p-3 mb-2">
        <div class="row g-0">
            <div class="col-md-6 border-end border-secondary border-opacity-25">
                <div class="source-item me-md-2">
                    <div class="d-flex align-items-center">
                        <span class="badge bg-info text-dark rounded-circle me-3"
                            style="width:12px; height:12px; padding:0;"></span>
                        <div class="d-flex flex-column">
                            <span class="text-white fw-bold">Official Sources</span>
                            <span class="text-gray-400 small" style="font-size: 0.75rem;">Aggregated from ArtsRepublic,
                                EventFinda & Gov.sg</span>
                        </div>
                    </div>
                    <span class="stat-badge bg-info bg-opacity-10 text-info border border-info border-opacity-25"
                        id="stat-official">0</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="source-item ms-md-2">
                    <div class="d-flex align-items-center">
                        <span class="badge bg-success text-dark rounded-circle me-3"
                            style="width:12px; height:12px; padding:0;"></span>
                        <div class="d-flex flex-column">
                            <span class="text-white fw-bold">Community</span>
                            <span class="text-gray-400 small" style="font-size: 0.75rem;">User-submitted local gigs,
                                workshops, and meetups</span>
                        </div>
                    </div>
                    <span
                        class="stat-badge bg-success bg-opacity-10 text-success border border-success border-opacity-25"
                        id="stat-community">0</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container pb-5">

    <div class="control-deck mb-5 shadow-lg">
        <div class="row g-3 align-items-center">

            <div class="col-lg-6">
                <div class="input-group search-input-group">
                    <span class="input-group-text bg-transparent border-0 ps-3"><i
                            class="bi bi-search text-gray-400"></i></span>
                    <input type="text" class="form-control border-0 bg-transparent" id="searchInput"
                        placeholder="Search events...">
                </div>
            </div>
            <div class="col-lg-6 text-center text-lg-end">
                <div class="d-flex flex-column flex-md-row justify-content-end gap-2 align-items-center">

                    <select
                        class="form-select form-select-sm bg-dark text-gray-300 border-secondary rounded-pill shadow-sm focus-ring-none"
                        style="width: auto; min-width: 160px; cursor: pointer;" id="sortSelect"
                        onchange="handleSortChange(this.value)">
                        <option value="upcoming|default" selected>üìÖ Upcoming (Soonest)</option>
                        <option value="upcoming|title_asc">üî§ Title (A-Z)</option>
                        <option value="upcoming|title_desc">üî§ Title (Z-A)</option>
                        <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                        <option value="past|default">üïí Past Events (Recent)</option>
                        <option value="past|date_asc">üïí Past Events (Oldest)</option>
                    </select>

                    <div class="segmented-control d-inline-flex bg-dark rounded-pill p-1 border border-secondary">
                        <button class="segmented-btn btn btn-sm rounded-pill px-3 active" onclick="setSource('all')"
                            id="btn-all">All</button>
                        <button class="segmented-btn btn btn-sm rounded-pill px-3" onclick="setSource('official')"
                            id="btn-official">Official</button>
                        <button class="segmented-btn btn btn-sm rounded-pill px-3" onclick="setSource('community')"
                            id="btn-community">Community</button>
                    </div>
                </div>
            </div>

            <div class="col-12 mt-3">
                <div id="category-scroll-container" class="category-scroll-wrapper d-flex gap-2 text-nowrap">
                    <button class="btn btn-sm btn-outline-secondary rounded-pill px-3 active-category flex-shrink-0"
                        onclick="setCategory('all', this)">All</button>
                    <button id="btn-preferences"
                        class="btn btn-sm btn-outline-secondary rounded-pill px-3 flex-shrink-0"
                        onclick="setCategory('preferences', this)">‚ô• For You</button>
                </div>
            </div>

            <div class="col-12" id="active-filter-row" style="display: none;">
                <div
                    class="alert bg-black bg-opacity-25 border border-secondary border-opacity-25 d-flex align-items-center justify-content-between py-2 px-3 mt-2 mb-0 rounded-3">
                    <div class="d-flex align-items-center text-gray-300 small">
                        <i class="bi bi-sliders2 me-2 text-primary"></i>
                        <span id="filter-info-text">Filtering...</span>
                    </div>
                    <a href="{{ url_for('main.profile') }}"
                        class="btn btn-sm btn-outline-secondary border-0 text-gray-400 py-0" style="font-size: 0.8rem;">
                        <i class="bi bi-pencil-square me-1"></i>Edit Interests
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-gray-400">Syncing databases...</p>
    </div>

    <div id="emptyState" class="text-center py-5" style="display: none;">
        <div class="mb-3">
            <i class="bi bi-folder2-open display-1 text-secondary opacity-25"></i>
        </div>
        <h4 class="text-white" id="empty-title">No events found</h4>
        <p class="text-gray-400" id="empty-desc">We couldn't find anything matching your filters.</p>
        <div id="empty-action">
            <button class="btn btn-primary rounded-pill px-4" onclick="resetFilters()">View All Events</button>
        </div>
    </div>

    <div id="eventsGrid" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4"></div>

    <div class="d-flex justify-content-center mt-5">
        <nav aria-label="Page navigation">
            <ul class="pagination pagination-sm" id="pagination"></ul>
        </nav>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 1. Update State
    const state = {
        allEvents: [],
        filteredEvents: [],
        currentPage: 1,
        itemsPerPage: 9,
        // Added 'sort' to filters
        filters: { source: 'all', category: 'all', search: '', time: 'upcoming', sort: 'default' },
        userPreferences: []
    };

    const isLoggedIn = "{{ 'true' if session.get('user_id') else 'false' }}" === "true";
    async function init() {
        await loadCategories();
        await loadUserPreferences();
        await fetchEvents();

        document.getElementById('searchInput').addEventListener('input', (e) => {
            state.filters.search = e.target.value;
            applyFilters();
        });
    }

    async function loadCategories() {
        try {
            const res = await fetch('/api/tags');
            const tags = await res.json();
            const container = document.getElementById('category-scroll-container');

            // Sort alphabetically
            tags.sort((a, b) => a.tag_name.localeCompare(b.tag_name));

            tags.forEach(tag => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm btn-outline-secondary rounded-pill px-3 flex-shrink-0';
                btn.textContent = tag.tag_name;
                btn.onclick = function () { setCategory(tag.tag_name, this); };
                container.appendChild(btn);
            });
        } catch (e) { console.error("Failed to load tags", e); }
    }

    async function loadUserPreferences() {
        try {
            const res = await fetch('/api/preferences/me');
            if (res.ok) {
                const data = await res.json();
                state.userPreferences = data.tags.map(t => t.tag_name);

                // Update button text
                const btn = document.getElementById('btn-preferences');
                if (btn) {
                    btn.textContent = `‚ô• For You (${state.userPreferences.length})`;
                }
            }
        } catch (e) { }
    }
    window.handleSortChange = function (value) {
        // Split value like "upcoming|title_asc"
        const [time, sort] = value.split('|');
        state.filters.time = time;
        state.filters.sort = sort;

        fetchEvents();
    };

    window.setTime = function (timeVal) {
        state.filters.time = timeVal;

        // Update UI
        const btnUpcoming = document.getElementById('btn-time-upcoming');
        const btnPast = document.getElementById('btn-time-past');

        if (timeVal === 'upcoming') {
            btnUpcoming.className = 'btn btn-sm btn-light fw-bold';
            btnPast.className = 'btn btn-sm btn-outline-secondary';
        } else {
            btnUpcoming.className = 'btn btn-sm btn-outline-secondary';
            btnPast.className = 'btn btn-sm btn-light fw-bold';
        }

        // RE-FETCH from Server (Client-side filtering isn't enough for date logic usually)
        fetchEvents();
    }

    window.setCategory = function (cat, btnElement) {
        state.filters.category = cat;
        const container = document.getElementById('category-scroll-container');

        // Reset ALL buttons to default outline style
        Array.from(container.children).forEach(child => {
            child.className = 'btn btn-sm btn-outline-secondary rounded-pill px-3 flex-shrink-0';
        });

        // Apply "Active" style (White Background) to the clicked button
        // This is now consistent for ALL categories, including "For You"
        btnElement.classList.remove('btn-outline-secondary');
        btnElement.classList.add('active-category', 'bg-light', 'text-dark', 'fw-bold');

        applyFilters();
    };

    window.setSource = function (source) {
        state.filters.source = source;
        document.querySelectorAll('.segmented-btn').forEach(btn => btn.classList.remove('active'));
        if (source === 'all') document.getElementById('btn-all').classList.add('active');
        if (source === 'official') document.getElementById('btn-official').classList.add('active');
        if (source === 'community') document.getElementById('btn-community').classList.add('active');
        applyFilters();
    }

    function applyFilters() {
        const row = document.getElementById('active-filter-row');
        const infoText = document.getElementById('filter-info-text');

        // 1. Handle "For You" mode logic
        if (state.filters.category === 'preferences') {

            // NEW: Check if user is logged in first
            if (!isLoggedIn) {
                if (row) row.style.setProperty('display', 'none', 'important');
                showEmptyState(
                    "Login Required",
                    "Please log in to see your personalized event feed.",
                    false
                );
                // Manually update the action button to a Login button
                const actionDiv = document.getElementById('empty-action');
                if (actionDiv) {
                    actionDiv.innerHTML = `<a href="/login" class="btn btn-primary rounded-pill px-4">Log In</a>`;
                }
                return;
            }
            // Case A: User has NO preferences set -> Show "No Interests" Empty State
            if (!state.userPreferences || state.userPreferences.length === 0) {
                if (row) row.style.setProperty('display', 'none', 'important');
                showEmptyState(
                    "No interests selected",
                    "You haven't set your interests yet. Go to your profile to personalize your feed.",
                    true
                );
                return; // Stop here
            }

            // Case B: User HAS preferences -> Show the Info Box
            const prefsString = state.userPreferences.join(', ');
            if (infoText) infoText.innerHTML = `Showing events for: <strong class="text-white">${prefsString}</strong>`;

            // Force display block
            if (row) row.style.setProperty('display', 'block', 'important');

        } else {
            // 2. Handle ANY other mode -> HIDE the box
            if (row) row.style.setProperty('display', 'none', 'important');
        }

        // --- Filtering Logic ---
        let results = state.allEvents || [];

        // Source Filter
        if (state.filters.source !== 'all') {
            results = results.filter(e => e.source === state.filters.source);
        }

        // Category Filter
        if (state.filters.category === 'preferences') {
            results = results.filter(e => {
                if (e.category && state.userPreferences.includes(e.category)) return true;
                if (e.tags && Array.isArray(e.tags)) {
                    return e.tags.some(t => state.userPreferences.includes(t));
                }
                return false;
            });
        } else if (state.filters.category !== 'all') {
            results = results.filter(e => {
                return e.category === state.filters.category || (e.tags && e.tags.includes(state.filters.category));
            });
        }

        // Search Filter
        if (state.filters.search) {
            const term = state.filters.search.toLowerCase();
            results = results.filter(e =>
                (e.title && e.title.toLowerCase().includes(term)) ||
                (e.venue && e.venue.toLowerCase().includes(term))
            );
        }

        state.filteredEvents = results;
        state.currentPage = 1;
        renderPage();
    }

    async function fetchEvents() {
        const loader = document.getElementById('loading');
        loader.style.display = 'block';
        document.getElementById('eventsGrid').style.display = 'none';

        try {
            const params = new URLSearchParams({
                source: state.filters.source,
                category: state.filters.category,
                time: state.filters.time,
                sort: state.filters.sort, // Send sort param
                q: state.filters.search
            });

            const res = await fetch(`/api/all-events?${params.toString()}`);
            const data = await res.json();

            if (data.status === 'success') {
                state.allEvents = data.events;
                document.getElementById('stat-total').textContent = data.total;
                document.getElementById('stat-official').textContent = data.official_count;
                document.getElementById('stat-community').textContent = data.community_count;
                applyFilters();
            }
        } catch (e) {
            console.error(e);
        } finally {
            loader.style.display = 'none';
            document.getElementById('eventsGrid').style.display = 'flex';
        }
    }

    function renderPage() {
        const grid = document.getElementById('eventsGrid');
        const empty = document.getElementById('emptyState');
        grid.innerHTML = '';

        // FIX: Removed the check for 'preferences'. Now shows empty state for ANY category with 0 results.
        if (state.filteredEvents.length === 0) {
            showEmptyState("No events found", "We couldn't find anything matching your filters.", false);
            return;
        }

        empty.style.display = 'none';
        document.getElementById('pagination').innerHTML = '';

        const start = (state.currentPage - 1) * state.itemsPerPage;
        const end = start + state.itemsPerPage;
        const items = state.filteredEvents.slice(start, end);

        items.forEach(event => {
            grid.innerHTML += createCardHtml(event);
        });

        renderPagination(Math.ceil(state.filteredEvents.length / state.itemsPerPage));
    }
    function showEmptyState(title, desc, isProfileRedirect) {
        document.getElementById('eventsGrid').innerHTML = '';
        document.getElementById('pagination').innerHTML = '';
        const empty = document.getElementById('emptyState');

        document.getElementById('empty-title').textContent = title;
        document.getElementById('empty-desc').textContent = desc;

        const actionDiv = document.getElementById('empty-action');
        if (isProfileRedirect) {
            // FIX: Changed class to 'btn-primary' (Blue) so it is visible against dark background
            actionDiv.innerHTML = `<a href="/profile" class="btn btn-primary rounded-pill px-4 fw-bold">Customize Profile</a>`;
        } else {
            actionDiv.innerHTML = `<button class="btn btn-primary rounded-pill px-4" onclick="resetFilters()">View All Events</button>`;
        }

        empty.style.display = 'block';
    }
    window.resetFilters = function () {
        state.filters.search = '';
        state.filters.category = 'all';
        state.filters.source = 'all';
        document.getElementById('searchInput').value = '';

        // Reset category buttons UI
        const container = document.getElementById('category-scroll-container');
        Array.from(container.children).forEach(child => {
            child.classList.remove('active-category', 'bg-light', 'text-dark', 'bg-warning', 'border-warning');
            child.classList.add('btn-outline-secondary');
        });
        // Set "All" as active
        container.firstElementChild.classList.add('active-category', 'bg-light', 'text-dark');
        container.firstElementChild.classList.remove('btn-outline-secondary');

        setSource('all');
    }

    function createCardHtml(event) {
        const fallback = "https://placehold.co/600x400/1e293b/475569?text=No+Image";
        const img = event.image ? event.image : fallback;
        let badgeClass = event.source === 'official' ? 'badge-official' : 'badge-community';
        let badgeText = event.source === 'official' ? 'Official' : 'Community';

        // NEW: Creator Logic
        let creatorHtml = '';
        if (event.source === 'community' && event.creator) {
            const avatar = event.creator.avatar || `https://ui-avatars.com/api/?name=${event.creator.username}&background=random`;
            creatorHtml = `
            <div class="d-flex align-items-center mt-2 pt-2 border-top border-secondary border-opacity-10">
                <a href="/user/${event.creator.id}" class="d-flex align-items-center text-decoration-none" style="z-index: 2; position: relative;">
                    <img src="${avatar}" class="rounded-circle me-2" width="24" height="24">
                    <small class="text-secondary hover-white">By ${event.creator.username}</small>
                </a>
            </div>`;
        }

        return `
        <div class="col">
            <div class="event-card h-100 d-flex flex-column">
                <div style="position: relative; height: 200px;">
                    <span class="badge-float ${badgeClass}">${badgeText}</span>
                    <img src="${img}" style="width:100%; height:100%; object-fit: cover; border-top-left-radius: 12px; border-top-right-radius: 12px;">
                </div>
                <div class="card-body p-3 d-flex flex-column flex-grow-1">
                    <small class="text-info fw-bold text-uppercase mb-2" style="font-size: 0.7rem; letter-spacing: 1px;">
                        ${event.category || 'EVENT'}
                    </small>
                    <h5 class="text-white fw-bold mb-3 text-truncate" title="${event.title}">
                        ${event.title}
                    </h5>
                    <div class="mt-auto">
                        <div class="d-flex align-items-center mb-2">
                            <i class="bi bi-calendar3 text-gray-400 me-2"></i>
                            <span class="text-gray-300 small">${event.date}</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-geo-alt-fill text-gray-400 me-2"></i>
                            <span class="text-gray-300 small text-truncate">${event.venue}</span>
                        </div>
                        ${creatorHtml} 
                    </div>
                </div>
                <div class="p-3 border-top border-secondary" style="border-color: rgba(255,255,255,0.08) !important;">
                    <a href="/event-detail?id=${event.id}" class="btn btn-outline-light btn-sm w-100 rounded-pill">View Details</a>
                </div>
            </div>
        </div>`;
    }
    function renderPagination(totalPages) {
        const pag = document.getElementById('pagination');
        pag.innerHTML = '';
        if (totalPages <= 1) return;

        let startPage = Math.max(1, state.currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);

        pag.innerHTML += `<li class="page-item ${state.currentPage === 1 ? 'disabled' : ''}">
            <button class="page-link bg-dark text-white border-secondary" onclick="goTo(${state.currentPage - 1})">‚Üê</button>
        </li>`;

        for (let i = startPage; i <= endPage; i++) {
            const isActive = i === state.currentPage;
            const btnClass = isActive ? 'bg-primary border-primary' : 'bg-dark text-white border-secondary';
            pag.innerHTML += `<li class="page-item ${isActive ? 'active' : ''}">
                <button class="page-link ${btnClass}" onclick="goTo(${i})">${i}</button>
            </li>`;
        }

        pag.innerHTML += `<li class="page-item ${state.currentPage === totalPages ? 'disabled' : ''}">
            <button class="page-link bg-dark text-white border-secondary" onclick="goTo(${state.currentPage + 1})">‚Üí</button>
        </li>`;
    }

    window.goTo = function (page) {
        state.currentPage = page;
        renderPage();
        document.getElementById('eventsGrid').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
{% endblock %}