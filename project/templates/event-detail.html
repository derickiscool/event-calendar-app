{% extends "base.html" %}
{% block title %}Event Details — Event Calendar{% endblock %}

{% block content %}
<style>
    /* --- COLOR & LAYOUT OVERRIDES --- */
    .text-gray-300 {
        color: #cbd5e1 !important;
    }

    .text-gray-400 {
        color: #94a3b8 !important;
    }

    /* Hero Image Section */
    .event-hero {
        position: relative;
        height: 400px;
        overflow: hidden;
        border-radius: 16px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.5);
    }

    .event-hero img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .event-hero-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(15, 23, 42, 0.95), transparent);
        padding: 2rem;
        padding-top: 6rem;
    }

    /* Badges (Consistent with Home) */
    .badge-official {
        background-color: #22d3ee;
        color: #0f172a;
    }

    .badge-community {
        background-color: #4ade80;
        color: #0f172a;
    }

    /* Sticky Sidebar Card */
    .action-card {
        background-color: #1e293b;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        position: sticky;
        top: 100px;
        /* Below navbar */
        z-index: 10;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
    }

    /* Review Cards */
    .review-card {
        background-color: #0f172a;
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }

    .star.filled {
        color: #fbbf24;
    }

    /* Amber-400 */
    .star.empty {
        color: #334155;
    }

    /* Slate-700 */

    /* Review Form */
    .review-form-container {
        background-color: #1e293b;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    /* Form Inputs */
    .form-control-dark {
        background-color: #020617;
        border: 1px solid #334155;
        color: #fff;
    }

    .form-control-dark:focus {
        background-color: #020617;
        color: #fff;
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
</style>

<div class="container py-5">

    <!-- 1. LOADING STATE -->
    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3 text-gray-400">Fetching event details...</p>
    </div>

    <!-- 2. ERROR STATE -->
    <div id="error" class="text-center py-5" style="display: none;">
        <i class="bi bi-exclamation-octagon display-1 text-danger opacity-50"></i>
        <h3 class="text-white mt-3">Event Not Found</h3>
        <p class="text-gray-400 mb-4" id="error-message">The event you are looking for does not exist or has been
            removed.</p>
        <a href="/" class="btn btn-outline-light rounded-pill px-4">← Return to Events</a>
    </div>

    <!-- 3. MAIN CONTENT -->
    <article id="event-detail" style="display: none;">

        <!-- Breadcrumb / Back Link -->
        <div class="mb-4">
            <a href="/" class="text-decoration-none text-gray-400 hover-white">
                <i class="bi bi-arrow-left me-1"></i> Back to Events
            </a>
        </div>

        <!-- HERO SECTION -->
        <div class="event-hero mb-5">
            <img id="event-image" src="" alt="Event Image">
            <div class="event-hero-overlay">
                <div class="d-flex gap-2 mb-3" id="event-badges">
                    <!-- JS Injects Badges Here -->
                </div>
                <h1 id="event-title" class="display-4 fw-bold text-white mb-2">Event Title</h1>
                <div class="d-flex align-items-center text-gray-300 gap-4 mt-3">
                    <span class="d-flex align-items-center"><i class="bi bi-calendar3 me-2 text-info"></i> <span
                            id="event-date">Date TBA</span></span>
                    <span class="d-flex align-items-center"><i class="bi bi-geo-alt-fill me-2 text-danger"></i> <span
                            id="event-venue">Venue TBA</span></span>
                </div>
            </div>
        </div>

        <div class="row g-5">

            <!-- LEFT COLUMN: Description & Reviews -->
            <div class="col-lg-8">

                <!-- About Section -->
                <div class="mb-5">
                    <h3 class="text-white fw-bold border-bottom border-secondary pb-3 mb-4">About This Event</h3>
                    <div id="event-description" class="text-gray-300 fs-5 lh-lg">
                        <p>Loading description...</p>
                    </div>
                </div>

                <!-- Location Detail (If available) -->
                <div id="location-item" class="mb-5" style="display: none;">
                    <h5 class="text-white fw-bold mb-3"><i class="bi bi-map me-2"></i>Full Address</h5>
                    <p id="event-location" class="text-gray-400 bg-dark p-3 rounded-3 border border-secondary"></p>
                </div>

                <!-- REVIEWS SECTION -->
                <section class="mt-5 pt-4 border-top border-secondary border-opacity-25">
                    <div class="d-flex align-items-center justify-content-between mb-4">
                        <h3 class="text-white fw-bold m-0">Reviews</h3>

                        <!-- Review Stats -->
                        <div id="reviews-summary" style="display: none;">
                            <div
                                class="d-flex align-items-center bg-dark px-3 py-1 rounded-pill border border-secondary">
                                <span class="text-warning fw-bold fs-5 me-2">★ <span id="avg-rating">0.0</span></span>
                                <span class="text-gray-400 small border-start border-secondary ps-2 ms-1"
                                    id="review-count">0 reviews</span>
                            </div>
                        </div>
                    </div>

                    <!-- 1. Review Form (Collapsible/Conditional) -->
                    <div class="review-form-container">
                        <h5 class="text-white mb-3" id="review-form-title">Write a Review</h5>
                        <form id="review-form">
                            <!-- Star Rating -->
                            <div class="mb-3">
                                <label class="text-gray-400 text-uppercase small fw-bold mb-2">Rating</label>

                                <div class="star-rating-input d-flex justify-content-end gap-2 fs-2">
                                    <input type="radio" name="rating" id="star5" value="5">
                                    <label for="star5" title="5 stars"><i class="bi bi-star-fill"></i></label>

                                    <input type="radio" name="rating" id="star4" value="4">
                                    <label for="star4" title="4 stars"><i class="bi bi-star-fill"></i></label>

                                    <input type="radio" name="rating" id="star3" value="3">
                                    <label for="star3" title="3 stars"><i class="bi bi-star-fill"></i></label>

                                    <input type="radio" name="rating" id="star2" value="2">
                                    <label for="star2" title="2 stars"><i class="bi bi-star-fill"></i></label>

                                    <input type="radio" name="rating" id="star1" value="1" required>
                                    <label for="star1" title="1 star"><i class="bi bi-star-fill"></i></label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="review-title"
                                    class="text-gray-400 text-uppercase small fw-bold mb-2">Title</label>
                                <input type="text" class="form-control form-control-dark" id="review-title"
                                    placeholder="Summarize your experience..." required maxlength="100">
                            </div>

                            <div class="mb-3">
                                <label for="review-comment"
                                    class="text-gray-400 text-uppercase small fw-bold mb-2">Review</label>
                                <textarea class="form-control form-control-dark" id="review-comment" rows="3"
                                    placeholder="Share details about the event..." required></textarea>
                            </div>

                            <button type="submit" class="btn btn-primary w-100 fw-bold">Submit Review</button>
                        </form>
                        <div id="review-message" class="alert mt-3" style="display: none;"></div>
                    </div>

                    <!-- 2. Your Review (Pinned) -->
                    <div id="user-review-card" class="mb-4" style="display: none;">
                        <h6 class="text-gray-400 text-uppercase small fw-bold mb-2">Your Review</h6>
                        <div class="review-card border-primary">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div id="user-review-stars" class="text-warning mb-2 fs-5"></div>
                                    <h5 id="user-review-title" class="text-white fw-bold"></h5>
                                    <p id="user-review-body" class="text-gray-300 mb-2"></p>
                                    <small id="user-review-date" class="text-gray-400"></small>
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary border-0"
                                        data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                                    <ul class="dropdown-menu dropdown-menu-dark">
                                        <li><a class="dropdown-item" href="#" id="edit-user-review-btn"><i
                                                    class="bi bi-pencil me-2"></i>Edit</a></li>
                                        <li><a class="dropdown-item text-danger" href="#" id="delete-user-review-btn"><i
                                                    class="bi bi-trash me-2"></i>Delete</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Other Reviews List -->
                    <h6 id="other-reviews-title" class="text-gray-400 text-uppercase small fw-bold mb-3 mt-5">Recent
                        Reviews</h6>
                    <div id="reviews-container">
                        <!-- JS Injects Reviews Here -->
                    </div>

                </section>
            </div>

            <!-- RIGHT COLUMN: Sticky Sidebar -->
            <div class="col-lg-4">
                <div class="action-card p-4">
                    <h4 class="text-white fw-bold mb-4">Event Actions</h4>

                    <div class="d-grid gap-3">
                        <a id="registration-link" href="#" target="_blank"
                            class="btn btn-primary btn-lg fw-bold rounded-pill shadow-sm">
                            Register Now <i class="bi bi-box-arrow-up-right ms-2"></i>
                        </a>

                        <button id="bookmark-btn"
                            class="btn btn-outline-light btn-lg rounded-pill d-flex align-items-center justify-content-center">
                            <i class="bi bi-bookmark me-2 bookmark-icon"></i>
                            <span class="bookmark-text">Save to Bookmarks</span>
                        </button>
                    </div>

                    <div class="mt-4 pt-4 border-top border-secondary border-opacity-25">
                        <small class="text-gray-400 d-block mb-2 text-center">Share this event</small>
                        <div class="d-flex justify-content-center gap-2">
                            <button class="btn btn-sm btn-dark border border-secondary text-gray-300"
                                onclick="navigator.clipboard.writeText(window.location.href); alert('Link copied!');"><i
                                    class="bi bi-link-45deg"></i> Copy Link</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </article>
</div>

<!-- Notification Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive"
        aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toast-message">Action successful</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const API_BASE = '/api';
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('id');

    const els = {
        loading: document.getElementById('loading'),
        error: document.getElementById('error'),
        detail: document.getElementById('event-detail'),
        title: document.getElementById('event-title'),
        img: document.getElementById('event-image'),
        badges: document.getElementById('event-badges'),
        date: document.getElementById('event-date'),
        venue: document.getElementById('event-venue'),
        locationBox: document.getElementById('location-item'),
        locationText: document.getElementById('event-location'),
        desc: document.getElementById('event-description'),
        regLink: document.getElementById('registration-link'),
        bookmarkBtn: document.getElementById('bookmark-btn'),
        // Review Els
        reviewContainer: document.getElementById('reviews-container'),
        userReviewCard: document.getElementById('user-review-card'),
        reviewFormContainer: document.querySelector('.review-form-container'),
        avgRating: document.getElementById('avg-rating'),
        reviewCount: document.getElementById('review-count'),
        reviewSummary: document.getElementById('reviews-summary')
    };

    let currentUserId = null;
    let hasUserReviewed = false;
    let editingReviewId = null;
    let isBookmarked = false;

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', async () => {
        if (!eventId) {
            showError('No event ID provided');
            return;
        }

        await getCurrentUser();
        await loadEventDetails();
        await loadReviews();
        checkBookmarkStatus();

        // Listeners
        document.getElementById('review-form').addEventListener('submit', handleReviewSubmit);
        els.bookmarkBtn.addEventListener('click', toggleBookmark);
    });

    // --- CORE DATA LOADING ---
    async function loadEventDetails() {
        try {
            const res = await fetch(`${API_BASE}/event/${encodeURIComponent(eventId)}`);
            if (!res.ok) throw new Error('Event not found');

            const data = await res.json();
            if (data.status === 'success') renderEvent(data.event);
            else throw new Error('Invalid Data');
        } catch (err) {
            console.error(err);
            showError(err.message);
        }
    }

    function renderEvent(event) {
        els.loading.style.display = 'none';
        els.detail.style.display = 'block';

        // Basic Info
        document.title = `${event.title} — Event Calendar`;
        els.title.textContent = event.title;
        els.img.src = event.image_url || event.image || "https://placehold.co/1200x600/1e293b/475569?text=Event+Image";
        els.venue.textContent = event.venue || 'TBA';

        // --- NEW: Smart Date & Time Formatting ---
        if (event.start_date) {
            const start = new Date(event.start_date);
            const dateOpts = { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' };
            const timeOpts = { hour: '2-digit', minute: '2-digit', hour12: true };

            let dateStr = start.toLocaleDateString('en-SG', dateOpts); // e.g. Sat, 6 Dec 2025
            const startTime = start.toLocaleTimeString('en-SG', timeOpts).toLowerCase();

            if (event.end_date) {
                const end = new Date(event.end_date);
                const endTime = end.toLocaleTimeString('en-SG', timeOpts).toLowerCase();

                // If same day, just show time range
                if (start.toDateString() === end.toDateString()) {
                    dateStr += ` • ${startTime} – ${endTime}`;
                } else {
                    // If multi-day, show end date too
                    const endDateStr = end.toLocaleDateString('en-SG', { day: 'numeric', month: 'short' });
                    dateStr += ` (${startTime}) – ${endDateStr} (${endTime})`;
                }
            } else {
                // No end time provided
                dateStr += ` • ${startTime}`;
            }
            els.date.textContent = dateStr;
        } else {
            els.date.textContent = 'Date TBA';
        }
        // ------------------------------------------

        // Badges
        let badgesHtml = '';
        const srcBadgeClass = event.source === 'official' ? 'badge-official' : 'badge-community';
        badgesHtml += `<span class="badge rounded-pill ${srcBadgeClass} fw-bold text-uppercase px-3 py-2">${event.source}</span>`;
        if (event.category && event.category !== 'other') {
            badgesHtml += `<span class="badge rounded-pill bg-dark border border-secondary text-gray-300 text-uppercase px-3 py-2 ms-2">${event.category}</span>`;
        }
        els.badges.innerHTML = badgesHtml;

        // Location
        if (event.address || event.location) {
            els.locationBox.style.display = 'block';
            els.locationText.textContent = event.address || event.location;
        }

        // Description
        if (event.description) {
            els.desc.innerHTML = event.description.split('\n').map(line => `<p>${line}</p>`).join('');
        } else {
            els.desc.innerHTML = '<p class="text-muted fst-italic">No description provided.</p>';
        }

        // Link
        if (event.registration_link) {
            els.regLink.href = event.registration_link;
            els.regLink.classList.remove('disabled');
            els.regLink.textContent = 'Register Now';
        } else {
            els.regLink.classList.add('disabled');
            els.regLink.textContent = 'No Registration Link';
            els.regLink.href = '#';
        }
    }

    function showError(msg) {
        els.loading.style.display = 'none';
        els.error.style.display = 'block';
        document.getElementById('error-message').innerText = msg;
    }

    // --- USER & AUTH ---
    async function getCurrentUser() {
        try {
            const res = await fetch(`${API_BASE}/profile/me`);
            if (res.ok) {
                const data = await res.json();
                currentUserId = data.user.id;
            }
        } catch (e) { }
    }

    // --- BOOKMARKS ---
    async function checkBookmarkStatus() {
        if (!currentUserId) return;
        try {
            const res = await fetch(`${API_BASE}/registered-events/check?event_id=${encodeURIComponent(eventId)}`);
            if (res.ok) {
                const data = await res.json();
                isBookmarked = data.is_registered;
                updateBookmarkUI();
            }
        } catch (e) { }
    }

    function updateBookmarkUI() {
        const icon = els.bookmarkBtn.querySelector('.bookmark-icon');
        const text = els.bookmarkBtn.querySelector('.bookmark-text');

        if (isBookmarked) {
            els.bookmarkBtn.classList.remove('btn-outline-light');
            els.bookmarkBtn.classList.add('btn-success', 'border-0');
            icon.className = 'bi bi-bookmark-check-fill me-2 bookmark-icon';
            text.textContent = 'Saved';
        } else {
            els.bookmarkBtn.classList.add('btn-outline-light');
            els.bookmarkBtn.classList.remove('btn-success', 'border-0');
            icon.className = 'bi bi-bookmark me-2 bookmark-icon';
            text.textContent = 'Save to Bookmarks';
        }
    }

    async function toggleBookmark() {
        if (!currentUserId) {
            showToast('Please log in to save events.', 'bg-danger');
            return;
        }

        els.bookmarkBtn.disabled = true;
        try {
            const method = isBookmarked ? 'DELETE' : 'POST';
            const url = isBookmarked ? `${API_BASE}/registered-events/${encodeURIComponent(eventId)}` : `${API_BASE}/registered-events`;
            const body = isBookmarked ? null : JSON.stringify({ event_id: eventId });

            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: body
            });

            if (res.ok) {
                isBookmarked = !isBookmarked;
                updateBookmarkUI();
                showToast(isBookmarked ? 'Event saved!' : 'Event removed from bookmarks.', 'bg-success');
            } else {
                showToast('Action failed.', 'bg-danger');
            }
        } catch (e) { console.error(e); }
        finally { els.bookmarkBtn.disabled = false; }
    }

    // --- REVIEWS LOGIC ---
    async function loadReviews() {
        try {
            const res = await fetch(`${API_BASE}/reviews?event_id=${encodeURIComponent(eventId)}`);
            if (res.ok) {
                const reviews = await res.json();
                renderReviews(reviews);
            }
        } catch (e) { }
    }

    function renderReviews(reviews) {
        // 1. Stats
        if (reviews.length > 0) {
            const total = reviews.reduce((sum, r) => sum + (r.rating || r.score || 0), 0);
            const avg = (total / reviews.length).toFixed(1);
            els.avgRating.textContent = avg;
            els.reviewCount.textContent = `${reviews.length} reviews`;
            els.reviewSummary.style.display = 'block';
        }

        // 2. Split User vs Others
        let userReview = null;
        let otherReviews = reviews;

        if (currentUserId) {
            userReview = reviews.find(r => r.user_id === currentUserId);
            otherReviews = reviews.filter(r => r.user_id !== currentUserId);
        }

        // 3. Render User Review Pinned
        if (userReview) {
            hasUserReviewed = true;
            els.reviewFormContainer.style.display = 'none'; // Hide form
            els.userReviewCard.style.display = 'block';

            // Populate User Card
            document.getElementById('user-review-title').textContent = userReview.title || 'No Title';
            document.getElementById('user-review-body').textContent = userReview.comment || userReview.body;
            document.getElementById('user-review-date').textContent = new Date(userReview.created_at).toLocaleDateString();
            document.getElementById('user-review-stars').innerHTML = generateStars(userReview.rating || userReview.score);

            // Bind Edit/Delete
            document.getElementById('delete-user-review-btn').onclick = () => deleteReview(userReview.id);
            document.getElementById('edit-user-review-btn').onclick = () => setupEdit(userReview);

        } else {
            hasUserReviewed = false;
            els.reviewFormContainer.style.display = currentUserId ? 'block' : 'none'; // Only show if logged in
            els.userReviewCard.style.display = 'none';
        }

        // 4. Render Others
        els.reviewContainer.innerHTML = '';
        if (otherReviews.length === 0) {
            els.reviewContainer.innerHTML = '<p class="text-gray-400 fst-italic">No other reviews yet.</p>';
            return;
        }

        otherReviews.forEach(r => {
            const html = `
            <div class="review-card">
                <div class="d-flex justify-content-between mb-2">
                    <span class="fw-bold text-white">${r.user_name || 'Anonymous'}</span>
                    <span class="text-gray-400 small">${new Date(r.created_at).toLocaleDateString()}</span>
                </div>
                <div class="text-warning small mb-2">${generateStars(r.rating || r.score)}</div>
                <h6 class="text-white fw-bold">${r.title || ''}</h6>
                <p class="text-gray-300 m-0">${r.comment || r.body}</p>
            </div>
        `;
            els.reviewContainer.innerHTML += html;
        });
    }

    function generateStars(score) {
        let html = '';
        for (let i = 1; i <= 5; i++) {
            html += i <= score ? '<i class="bi bi-star-fill me-1"></i>' : '<i class="bi bi-star me-1 text-secondary"></i>';
        }
        return html;
    }

    // --- REVIEW ACTIONS ---
    async function handleReviewSubmit(e) {
        e.preventDefault();
        if (!currentUserId) return;

        const ratingEl = document.querySelector('input[name="rating"]:checked');
        if (!ratingEl) { showToast('Please select a star rating', 'bg-warning'); return; }

        const payload = {
            rating: parseInt(ratingEl.value),
            title: document.getElementById('review-title').value,
            comment: document.getElementById('review-comment').value
        };

        // If CREATE, add event_id. If UPDATE, using PUT endpoint usually expects score/body/title
        if (!editingReviewId) payload.event_id = eventId;
        else {
            // Adapt to backend mapping if needed (some backends use score vs rating)
            payload.score = payload.rating;
            payload.body = payload.comment;
        }

        const url = editingReviewId ? `${API_BASE}/reviews/${editingReviewId}` : `${API_BASE}/reviews`;
        const method = editingReviewId ? 'PUT' : 'POST';

        try {
            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                showToast('Review saved successfully!', 'bg-success');
                document.getElementById('review-form').reset();
                editingReviewId = null;
                await loadReviews(); // Reload to refresh UI
            } else {
                const err = await res.json();
                showToast(err.error || 'Failed to save review', 'bg-danger');
            }
        } catch (e) { console.error(e); }
    }

    async function deleteReview(reviewId) {
        if (!confirm('Delete this review?')) return;
        try {
            const res = await fetch(`${API_BASE}/reviews/${reviewId}`, { method: 'DELETE' });
            if (res.ok) {
                showToast('Review deleted.', 'bg-success');
                await loadReviews();
            }
        } catch (e) { }
    }

    function setupEdit(review) {
        editingReviewId = review.id;

        // Show form, hide card
        els.reviewFormContainer.style.display = 'block';
        els.userReviewCard.style.display = 'none';

        document.getElementById('review-form-title').textContent = 'Edit Your Review';
        document.getElementById('review-title').value = review.title || '';
        document.getElementById('review-comment').value = review.comment || review.body || '';

        // Check radio
        const score = review.rating || review.score;
        const radio = document.querySelector(`input[name="rating"][value="${score}"]`);
        if (radio) radio.checked = true;

        // Scroll to form
        els.reviewFormContainer.scrollIntoView({ behavior: 'smooth' });
    }

    function showToast(msg, bgClass = 'text-bg-primary') {
        const toastEl = document.getElementById('liveToast');
        const toastBody = document.getElementById('toast-message');
        toastEl.className = `toast align-items-center border-0 ${bgClass}`;
        toastBody.textContent = msg;
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }

</script>
{% endblock %}