{% extends "base.html" %}
{% block title %}Event Details ‚Äî Event Calendar{% endblock %}

{% block content %}
<div class="page-event-detail">
  <div class="container">
    <!-- Loading State -->
    <div id="loading" class="loading-state">
      <p>Loading event details...</p>
    </div>

    <!-- Error State -->
    <div id="error" class="error-state" style="display: none;">
      <p id="error-message">Event not found</p>
      <a href="/" class="btn btn-primary">‚Üê Back to Events</a>
    </div>

    <!-- Event Detail Content -->
    <article id="event-detail" style="display: none;">
      <div class="event-header">
        <a href="/" class="back-link">‚Üê Back to Events</a>
        <div class="event-badges" id="event-badges"></div>
      </div>

      <div class="event-image-container">
        <img id="event-image" src="" alt="" class="event-detail-image">
      </div>

      <div class="event-content">
        <h1 id="event-title" class="event-detail-title">Event Title</h1>

        <div class="event-meta-grid">
          <div class="meta-item">
            <span class="meta-icon">üìÖ</span>
            <div class="meta-content">
              <strong>Date</strong>
              <p id="event-date">Date TBA</p>
            </div>
          </div>

          <div class="meta-item">
            <span class="meta-icon">üìç</span>
            <div class="meta-content">
              <strong>Venue</strong>
              <p id="event-venue">Venue TBA</p>
            </div>
          </div>

          <div class="meta-item" id="location-item" style="display: none;">
            <span class="meta-icon">üó∫Ô∏è</span>
            <div class="meta-content">
              <strong>Address</strong>
              <p id="event-location">Address</p>
            </div>
          </div>
        </div>

        <div class="event-description-section">
          <h2>About This Event</h2>
          <div id="event-description" class="event-description">
            <p>Event description will appear here...</p>
          </div>
        </div>

        <div class="event-actions" id="event-actions" style="display: none;">
          <button id="bookmark-btn" class="btn btn-secondary bookmark-btn" style="display: none;">
            <span class="bookmark-icon">üîñ</span>
            <span class="bookmark-text">Bookmark Event</span>
          </button>
          <a id="registration-link" href="#" target="_blank" class="btn btn-primary">Register Now</a>
        </div>

        <!-- Reviews Section -->
        <div class="reviews-section">
          <h2>Reviews & Ratings</h2>

          <!-- Reviews Summary -->
          <div id="reviews-summary" class="reviews-summary" style="display: none;">
            <div class="average-rating">
              <span id="avg-rating" class="rating-number">0.0</span>
              <div class="stars" id="avg-stars"></div>
              <span id="review-count" class="review-count">0 reviews</span>
            </div>
          </div>

          <!-- Your Review (Pinned at Top) -->
          <div id="user-review-card" class="user-review-card" style="display: none;">
            <div class="user-review-header">
              <h3>Your Review</h3>
              <div class="user-review-actions">
                <button id="edit-user-review-btn" class="btn-icon" title="Edit review">
                  <span>‚úèÔ∏è</span>
                </button>
                <button id="delete-user-review-btn" class="btn-icon" title="Delete review">
                  <span>üóëÔ∏è</span>
                </button>
              </div>
            </div>
            <div class="user-review-content">
              <div class="user-review-rating" id="user-review-stars"></div>
              <h4 id="user-review-title" class="user-review-title"></h4>
              <p id="user-review-body" class="user-review-body"></p>
              <span id="user-review-date" class="user-review-date"></span>
            </div>
          </div>

          <!-- Submit Review Form -->
          <div class="review-form-container">
            <h3 id="review-form-title">Write a Review</h3>
            <form id="review-form" class="review-form">
              <div class="form-group">
                <label for="review-rating">Rating *</label>
                <div class="star-rating-input">
                  <input type="radio" id="star5" name="rating" value="5" required>
                  <label for="star5" title="5 stars">‚òÖ</label>
                  <input type="radio" id="star4" name="rating" value="4">
                  <label for="star4" title="4 stars">‚òÖ</label>
                  <input type="radio" id="star3" name="rating" value="3">
                  <label for="star3" title="3 stars">‚òÖ</label>
                  <input type="radio" id="star2" name="rating" value="2">
                  <label for="star2" title="2 stars">‚òÖ</label>
                  <input type="radio" id="star1" name="rating" value="1">
                  <label for="star1" title="1 star">‚òÖ</label>
                </div>
              </div>

              <div class="form-group">
                <label for="review-title">Review Title *</label>
                <input type="text" id="review-title" name="title" placeholder="Summarize your experience" required
                  maxlength="255">
              </div>

              <div class="form-group">
                <label for="review-comment">Your Review *</label>
                <textarea id="review-comment" name="comment" rows="4"
                  placeholder="Share your experience with this event..." required></textarea>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn-primary">Submit Review</button>
              </div>
            </form>
            <div id="review-message" class="review-message" style="display: none;"></div>
          </div>

          <!-- Existing Reviews List -->
          <div class="reviews-list">
            <h3 id="other-reviews-title">Reviews</h3>
            <div id="reviews-container" class="reviews-container">
              <p class="no-reviews">No reviews yet. Be the first to review!</p>
            </div>
          </div>
        </div>
      </div>
    </article>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script type="module">
  const API_BASE = window.API_BASE || '/api';

  // Get event ID from URL
  const urlParams = new URLSearchParams(window.location.search);
  const eventId = urlParams.get('id');

  const loading = document.getElementById('loading');
  const error = document.getElementById('error');
  const eventDetail = document.getElementById('event-detail');

  if (!eventId) {
    showError('No event ID provided');
  } else {
    loadEventDetails(eventId);
  }

  async function loadEventDetails(id) {
    try {
      const response = await fetch(`${API_BASE}/event/${encodeURIComponent(id)}`);

      if (!response.ok) {
        throw new Error('Event not found');
      }

      const data = await response.json();

      if (data.status === 'success' && data.event) {
        displayEvent(data.event);
      } else {
        throw new Error('Invalid response format');
      }
    } catch (err) {
      console.error('Error loading event:', err);
      showError(err.message || 'Failed to load event details');
    }
  }

  function displayEvent(event) {
    // Hide loading, show content
    loading.style.display = 'none';
    eventDetail.style.display = 'block';

    // Set title and meta tags
    document.title = `${event.title} ‚Äî Event Calendar`;

    // Event title
    document.getElementById('event-title').textContent = event.title;

    // Event image
    const imgEl = document.getElementById('event-image');
    imgEl.src = event.image_url || event.image || '/static/assets/images/default-event.svg';
    imgEl.alt = event.title;
    imgEl.onerror = function () {
      this.src = '/static/assets/images/default-event.svg';
    };

    // Badges
    const badgesContainer = document.getElementById('event-badges');
    let badges = [];

    if (event.category && event.category !== 'other') {
      badges.push(`<span class="badge badge-${event.category}">${formatCategory(event.category)}</span>`);
    }

    badges.push(`<span class="badge badge-${event.source}">${event.source === 'official' ? 'üèõÔ∏è Official' : 'üë• Community'}</span>`);
    badgesContainer.innerHTML = badges.join('');

    // Date
    document.getElementById('event-date').textContent = event.date || 'Date TBA';

    // Venue
    document.getElementById('event-venue').textContent = event.venue || 'Venue TBA';

    // Location (address)
    if (event.location) {
      document.getElementById('location-item').style.display = 'flex';
      document.getElementById('event-location').textContent = event.location;
    }

    // Description
    const descEl = document.getElementById('event-description');
    if (event.description) {
      // Convert line breaks to paragraphs
      const paragraphs = event.description.split('\n').filter(p => p.trim());
      descEl.innerHTML = paragraphs.map(p => `<p>${escapeHtml(p)}</p>`).join('');
    } else {
      descEl.innerHTML = '<p><em>No description available</em></p>';
    }

    // Registration link and bookmark button
    document.getElementById('event-actions').style.display = 'block';

    if (event.registration_link) {
      document.getElementById('registration-link').href = event.registration_link;
      document.getElementById('registration-link').style.display = 'inline-block';
    } else {
      document.getElementById('registration-link').style.display = 'none';
    }

    // Always show bookmark button
    document.getElementById('bookmark-btn').style.display = 'inline-block';
    checkBookmarkStatus(event.id);
  }

  function showError(message) {
    loading.style.display = 'none';
    error.style.display = 'block';
    document.getElementById('error-message').textContent = message;
  }

  function formatCategory(category) {
    const categories = {
      'music': 'Music',
      'theatre': 'Theatre',
      'comedy': 'Comedy',
      'film': 'Film',
      'visual-arts': 'Visual Arts',
      'workshops': 'Workshops',
      'other': 'Other'
    };
    return categories[category] || category;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ===== REVIEWS FUNCTIONALITY =====

  let currentUserId = null;
  let hasUserReviewed = false;

  // Get current user
  async function getCurrentUser() {
    try {
      const response = await fetch(`${API_BASE}/profile/me`, {
        credentials: 'include'
      });

      if (response.ok) {
        const data = await response.json();
        currentUserId = data.user.id;
      }
    } catch (err) {
      console.error('Error getting current user:', err);
    }
  }

  // Load reviews for the event
  async function loadReviews(eventId) {
    try {
      const response = await fetch(`${API_BASE}/reviews?event_id=${encodeURIComponent(eventId)}`);

      if (!response.ok) {
        throw new Error('Failed to load reviews');
      }

      const reviews = await response.json();
      displayReviews(reviews);
      updateReviewsSummary(reviews);
    } catch (err) {
      console.error('Error loading reviews:', err);
    }
  }

  // Display reviews in the list
  function displayReviews(reviews) {
    const container = document.getElementById('reviews-container');
    const userReviewCard = document.getElementById('user-review-card');
    const otherReviewsTitle = document.getElementById('other-reviews-title');

    console.log('Displaying reviews:', reviews);

    // Separate user's review from others
    let userReview = null;
    let otherReviews = [];
    
    if (currentUserId && reviews && reviews.length > 0) {
      userReview = reviews.find(review => review.user_id === currentUserId);
      otherReviews = reviews.filter(review => review.user_id !== currentUserId);
    } else {
      otherReviews = reviews || [];
    }

    hasUserReviewed = userReview !== null;
    
    // Display user's review in pinned card
    if (userReview) {
      displayUserReviewCard(userReview);
      otherReviewsTitle.textContent = 'Other Reviews';
    } else {
      userReviewCard.style.display = 'none';
      otherReviewsTitle.textContent = 'Reviews';
    }
    
    updateReviewFormVisibility();

    // Display other reviews
    if (otherReviews.length === 0) {
      if (userReview) {
        container.innerHTML = '<p class="no-reviews">No other reviews yet.</p>';
      } else {
        container.innerHTML = '<p class="no-reviews">No reviews yet. Be the first to review!</p>';
      }
      return;
    }

    container.innerHTML = otherReviews.map(review => {
      console.log('Processing review:', review);

      // API returns 'rating' and 'comment', normalize to score/body for consistency
      const score = review.rating || review.score;
      const body = review.comment || review.body;
      const title = review.title || '';

      return `
        <div class="review-card" data-review-id="${review.id}">
          <div class="review-header">
            <div class="review-author">
              <strong>${escapeHtml(review.user_name || 'Anonymous')}</strong>
              <span class="review-date">${formatDate(review.created_at)}</span>
            </div>
            <div class="review-rating">
              ${generateStars(score)}
            </div>
          </div>
          ${title ? `<h4 class="review-title">${escapeHtml(title)}</h4>` : ''}
          <div class="review-body">
            <p>${escapeHtml(body)}</p>
          </div>
        </div>
      `;
    }).join('');
  }

  // Display user's review in pinned card
  function displayUserReviewCard(review) {
    const userReviewCard = document.getElementById('user-review-card');
    const starsEl = document.getElementById('user-review-stars');
    const titleEl = document.getElementById('user-review-title');
    const bodyEl = document.getElementById('user-review-body');
    const dateEl = document.getElementById('user-review-date');

    // Normalize field names
    const score = review.rating || review.score;
    const body = review.comment || review.body;
    const title = review.title || '';

    starsEl.innerHTML = generateStars(score);
    titleEl.textContent = title;
    bodyEl.textContent = body;
    dateEl.textContent = formatDate(review.created_at);

    userReviewCard.style.display = 'block';

    // Set up edit and delete button handlers
    const editBtn = document.getElementById('edit-user-review-btn');
    const deleteBtn = document.getElementById('delete-user-review-btn');

    editBtn.onclick = () => editReview(review.id, title, body, score);
    deleteBtn.onclick = () => deleteReview(review.id);
  }

  // Update reviews summary (average rating)
  function updateReviewsSummary(reviews) {
    if (!reviews || reviews.length === 0) return;

    const summaryEl = document.getElementById('reviews-summary');
    const avgRatingEl = document.getElementById('avg-rating');
    const avgStarsEl = document.getElementById('avg-stars');
    const reviewCountEl = document.getElementById('review-count');

    // API returns 'rating', fallback to 'score' for consistency
    const avgRating = reviews.reduce((sum, r) => sum + (r.rating || r.score), 0) / reviews.length;

    summaryEl.style.display = 'block';
    avgRatingEl.textContent = avgRating.toFixed(1);
    avgStarsEl.innerHTML = generateStars(avgRating);
    reviewCountEl.textContent = `${reviews.length} ${reviews.length === 1 ? 'review' : 'reviews'}`;
  }

  // Generate star HTML
  function generateStars(rating) {
    const fullStars = Math.floor(rating);
    const hasHalfStar = rating % 1 >= 0.5;
    const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

    let html = '';
    for (let i = 0; i < fullStars; i++) html += '<span class="star filled">‚òÖ</span>';
    if (hasHalfStar) html += '<span class="star half">‚òÖ</span>';
    for (let i = 0; i < emptyStars; i++) html += '<span class="star empty">‚òÜ</span>';

    return html;
  }

  // Format date
  function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
    if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;

    return date.toLocaleDateString();
  }

  let editingReviewId = null;

  // Update review form visibility based on whether user has already reviewed
  function updateReviewFormVisibility() {
    const formContainer = document.querySelector('.review-form-container');
    const formTitle = document.getElementById('review-form-title');
    
    if (hasUserReviewed && editingReviewId === null) {
      // User has already reviewed and is not editing - hide form
      if (formContainer) formContainer.style.display = 'none';
    } else {
      // User hasn't reviewed yet or is editing - show form
      if (formContainer) formContainer.style.display = 'block';
      if (formTitle && editingReviewId === null) {
        formTitle.textContent = 'Write a Review';
      }
    }
  }

  // Edit review
  window.editReview = function(reviewId, title, body, score) {
    console.log('editReview called with:', { reviewId, title, body, score });
    editingReviewId = reviewId;
    
    // Show the form when editing
    updateReviewFormVisibility();
    
    // Populate form with review data
    const titleInput = document.getElementById('review-title');
    const commentInput = document.getElementById('review-comment');
    const ratingInput = document.querySelector(`input[name="rating"][value="${score}"]`);
    
    console.log('Form elements:', { titleInput, commentInput, ratingInput });
    
    if (titleInput) titleInput.value = title;
    if (commentInput) commentInput.value = body;
    if (ratingInput) ratingInput.checked = true;

    // Change form title and button text
    const formTitle = document.querySelector('.review-form-container h3');
    const submitBtn = document.querySelector('#review-form button[type="submit"]');
    formTitle.textContent = 'Edit Your Review';
    submitBtn.textContent = 'Update Review';    // Add cancel button
    if (!document.getElementById('cancel-edit-btn')) {
      const cancelBtn = document.createElement('button');
      cancelBtn.type = 'button';
      cancelBtn.id = 'cancel-edit-btn';
      cancelBtn.className = 'btn btn-secondary';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.onclick = cancelEditReview;
      submitBtn.parentElement.appendChild(cancelBtn);
    }

    // Scroll to form
    document.querySelector('.review-form-container').scrollIntoView({ behavior: 'smooth' });
  };

  // Cancel edit
  function cancelEditReview() {
    editingReviewId = null;
    document.getElementById('review-form').reset();

    const formTitle = document.querySelector('.review-form-container h3');
    const submitBtn = document.querySelector('#review-form button[type="submit"]');
    formTitle.textContent = 'Write a Review';
    submitBtn.textContent = 'Submit Review';

    const cancelBtn = document.getElementById('cancel-edit-btn');
    if (cancelBtn) cancelBtn.remove();
    
    // Hide form again if user has already reviewed
    updateReviewFormVisibility();
  }

  // Delete review
  window.deleteReview = async function (reviewId) {
    if (!confirm('Are you sure you want to delete this review? This action cannot be undone.')) {
      return;
    }

    try {
      const response = await fetch(`${API_BASE}/reviews/${reviewId}`, {
        method: 'DELETE',
        credentials: 'include'
      });

      if (response.ok) {
        showReviewMessage('Review deleted successfully!', 'success');
        setTimeout(() => {
          loadReviews(eventId);
          document.getElementById('review-message').style.display = 'none';
        }, 1500);
      } else {
        const data = await response.json();
        showReviewMessage(data.error || 'Failed to delete review', 'error');
      }
    } catch (err) {
      console.error('Error deleting review:', err);
      showReviewMessage('Failed to delete review. Please try again.', 'error');
    }
  };

  // Handle review form submission
  document.getElementById('review-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const rating = document.querySelector('input[name="rating"]:checked');
    const title = document.getElementById('review-title').value;
    const comment = document.getElementById('review-comment').value;
    const messageEl = document.getElementById('review-message');

    if (!rating) {
      showReviewMessage('Please select a rating', 'error');
      return;
    }

    try {
      const isEditing = editingReviewId !== null;
      const url = isEditing ? `${API_BASE}/reviews/${editingReviewId}` : `${API_BASE}/reviews`;
      const method = isEditing ? 'PUT' : 'POST';

      // Different field names for create vs update
      const requestBody = isEditing ? {
        score: parseInt(rating.value),
        title: title.trim(),
        body: comment.trim()
      } : {
        event_id: eventId,
        rating: parseInt(rating.value),
        title: title.trim(),
        comment: comment.trim()
      };

      const response = await fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include',
        body: JSON.stringify(requestBody)
      });

      const data = await response.json();

      if (response.ok) {
        showReviewMessage(isEditing ? 'Review updated successfully!' : 'Review submitted successfully!', 'success');
        document.getElementById('review-form').reset();
        if (isEditing) {
          cancelEditReview();
        } else {
          // Mark that user has now reviewed
          hasUserReviewed = true;
          updateReviewFormVisibility();
        }
        // Reload reviews
        setTimeout(() => {
          loadReviews(eventId);
          messageEl.style.display = 'none';
        }, 2000);
      } else {
        showReviewMessage(data.error || `Failed to ${isEditing ? 'update' : 'submit'} review`, 'error');
      }
    } catch (err) {
      console.error('Error submitting review:', err);
      showReviewMessage('Failed to submit review. Please try again.', 'error');
    }
  });

  // Show review submission message
  function showReviewMessage(message, type) {
    const messageEl = document.getElementById('review-message');
    messageEl.textContent = message;
    messageEl.className = `review-message ${type}`;
    messageEl.style.display = 'block';
  }

  // ===== BOOKMARK FUNCTIONALITY =====

  let isBookmarked = false;

  // Check if event is bookmarked
  async function checkBookmarkStatus(eventId) {
    try {
      const response = await fetch(`${API_BASE}/registered-events/check?event_id=${encodeURIComponent(eventId)}`, {
        credentials: 'include'
      });

      if (response.ok) {
        const data = await response.json();
        isBookmarked = data.is_registered;
        updateBookmarkButton();
      }
    } catch (err) {
      console.error('Error checking bookmark status:', err);
    }
  }

  // Update bookmark button appearance
  function updateBookmarkButton() {
    const btn = document.getElementById('bookmark-btn');
    const icon = btn.querySelector('.bookmark-icon');
    const text = btn.querySelector('.bookmark-text');

    if (isBookmarked) {
      btn.classList.add('bookmarked');
      icon.textContent = '‚úÖ';
      text.textContent = 'Bookmarked';
    } else {
      btn.classList.remove('bookmarked');
      icon.textContent = 'üîñ';
      text.textContent = 'Bookmark Event';
    }
  }

  // Handle bookmark button click
  document.getElementById('bookmark-btn').addEventListener('click', async () => {
    const btn = document.getElementById('bookmark-btn');

    // Disable button during request
    btn.disabled = true;

    try {
      if (isBookmarked) {
        // Remove bookmark
        const response = await fetch(`${API_BASE}/registered-events/${encodeURIComponent(eventId)}`, {
          method: 'DELETE',
          credentials: 'include'
        });

        const data = await response.json();

        if (response.ok) {
          isBookmarked = false;
          updateBookmarkButton();
          showBookmarkNotification('Bookmark removed', 'success');
        } else {
          showBookmarkNotification(data.error || 'Failed to remove bookmark', 'error');
        }
      } else {
        // Add bookmark
        const response = await fetch(`${API_BASE}/registered-events`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            event_id: eventId
          })
        });

        const data = await response.json();

        if (response.ok) {
          isBookmarked = true;
          updateBookmarkButton();
          showBookmarkNotification('Event bookmarked!', 'success');
        } else {
          if (response.status === 401) {
            showBookmarkNotification('Please log in to bookmark events', 'error');
          } else {
            showBookmarkNotification(data.error || 'Failed to bookmark event', 'error');
          }
        }
      }
    } catch (err) {
      console.error('Error toggling bookmark:', err);
      showBookmarkNotification('Failed to update bookmark', 'error');
    } finally {
      btn.disabled = false;
    }
  });

  // Show bookmark notification
  function showBookmarkNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `bookmark-notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => notification.classList.add('show'), 10);

    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  // Load reviews when event is loaded
  if (eventId) {
    getCurrentUser().then(() => {
      loadReviews(eventId);
    });
  }
</script>
{% endblock %}