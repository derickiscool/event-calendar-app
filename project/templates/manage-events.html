{% extends "base.html" %}
{% block title %}Manage Events — Event Calendar{% endblock %}

{% block content %}
<style>
  /* --- Page Specific Styles --- */

  /* Grid Layout */
  .events-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
  }

  /* Event Card Styling */
  .event-card {
    background-color: #1e293b;
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 12px;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
    height: 100%;
    display: flex;
    flex-direction: column;
    position: relative;
  }

  .event-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
    border-color: rgba(59, 130, 246, 0.5);
  }

  .card-img-wrapper {
    position: relative;
    height: 180px;
    width: 100%;
    background-color: #0f172a;
    display: block;
    /* Make anchor block */
  }

  .card-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .badge-float {
    position: absolute;
    top: 12px;
    right: 12px;
    font-size: 0.7rem;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    z-index: 2;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .badge-community {
    background-color: #4ade80;
    color: #0f172a;
  }

  .badge-past {
    background-color: #64748b;
    color: #fff;
  }

  .card-content {
    padding: 1.25rem;
    display: flex;
    flex-direction: column;
    flex-grow: 1;
  }

  .event-title {
    font-size: 1.15rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 0.75rem;
    line-height: 1.4;
    text-decoration: none;
    display: block;
  }

  .event-title:hover {
    color: #4da3ff;
  }

  .event-meta {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    font-size: 0.9rem;
    color: #94a3b8;
    margin-bottom: 1rem;
  }

  .event-meta i {
    width: 20px;
    text-align: center;
    margin-right: 6px;
  }

  .event-actions {
    margin-top: auto;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    display: flex;
    gap: 0.5rem;
  }

  /* Toggle Buttons */
  .filter-toggle {
    background: rgba(30, 41, 59, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 0.5rem;
    border-radius: 50px;
    display: inline-flex;
  }

  .filter-btn {
    color: #94a3b8;
    border: none;
    background: transparent;
    padding: 0.5rem 1.5rem;
    border-radius: 50px;
    font-weight: 500;
    font-size: 0.9rem;
    transition: all 0.2s;
  }

  .filter-btn:hover {
    color: #fff;
  }

  .filter-btn.active {
    background-color: #334155;
    color: #fff;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  /* Empty State */
  .empty-state-icon {
    font-size: 4rem;
    color: #334155;
    margin-bottom: 1rem;
  }
</style>

<div class="container py-5">

  <div class="row mb-4">
    <div class="col-12 text-center">
      <h2 class="fw-bold text-white mb-2">Manage Your Events</h2>
      <p class="text-gray-400">Create, edit, and track your events.</p>

      <div class="mt-4">
        <div class="filter-toggle">
          <button class="filter-btn active" id="btn-upcoming" onclick="setFilter('upcoming')">Upcoming</button>
          <button class="filter-btn" id="btn-past" onclick="setFilter('past')">Past / Archived</button>
        </div>
      </div>

      <div class="mt-4">
        <a href="{{ url_for('main.event_new') }}" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm">
          <i class="bi bi-plus-lg me-2"></i>Create New Event
        </a>
      </div>
    </div>
  </div>

  <div id="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-3 text-gray-400">Loading your events...</p>
  </div>

  <div id="empty-state" class="text-center py-5" style="display: none;">
    <div class="empty-state-icon">
      <i class="bi bi-calendar-x"></i>
    </div>
    <h4 class="text-white" id="empty-title">No Events Found</h4>
    <p class="text-gray-400 mb-4" id="empty-desc">You don't have any events in this category.</p>
  </div>

  <div id="error-state" class="text-center py-5" style="display: none;">
    <div class="text-danger mb-3"><i class="bi bi-exclamation-circle display-4"></i></div>
    <h5 class="text-white">Something went wrong</h5>
    <p id="error-message" class="text-gray-400"></p>
    <button class="btn btn-outline-light btn-sm mt-2" onclick="location.reload()">Try Again</button>
  </div>

  <div id="events-list" class="events-grid" style="display: none;"></div>

</div>
{% endblock %}

{% block scripts %}
<script type="module">
  const API_BASE = window.API_BASE || '/api';

  // State
  let allEvents = [];
  let currentFilter = 'upcoming';

  // DOM Elements
  const els = {
    loading: document.getElementById('loading'),
    empty: document.getElementById('empty-state'),
    emptyTitle: document.getElementById('empty-title'),
    emptyDesc: document.getElementById('empty-desc'),
    error: document.getElementById('error-state'),
    errorMsg: document.getElementById('error-message'),
    list: document.getElementById('events-list'),
    btnUpcoming: document.getElementById('btn-upcoming'),
    btnPast: document.getElementById('btn-past')
  };

  document.addEventListener('DOMContentLoaded', loadEvents);

  // Make available globally for onclick in HTML
  window.setFilter = function (filter) {
    currentFilter = filter;

    // Update Buttons
    if (filter === 'upcoming') {
      els.btnUpcoming.classList.add('active');
      els.btnPast.classList.remove('active');
    } else {
      els.btnUpcoming.classList.remove('active');
      els.btnPast.classList.add('active');
    }

    renderFilteredEvents();
  };

  async function loadEvents() {
    try {
      const res = await fetch(`${API_BASE}/events/my-events`, {
        credentials: 'include'
      });

      if (!res.ok) {
        if (res.status === 401) {
          window.location.href = '/login';
          return;
        }
        throw new Error('Failed to fetch events');
      }

      allEvents = await res.json();
      renderFilteredEvents();

    } catch (err) {
      console.error(err);
      showError('Failed to load your events. Please check your connection.');
    }
  }

  function renderFilteredEvents() {
    els.loading.style.display = 'none';

    const now = new Date();

    // Filter logic
    const filtered = allEvents.filter(e => {
      const eventDate = new Date(e.start_datetime);
      if (currentFilter === 'upcoming') {
        return eventDate >= now;
      } else {
        return eventDate < now;
      }
    });

    // Sort: Upcoming = Ascending (Sooner first), Past = Descending (Most recent first)
    filtered.sort((a, b) => {
      const da = new Date(a.start_datetime);
      const db = new Date(b.start_datetime);
      return currentFilter === 'upcoming' ? da - db : db - da;
    });

    if (filtered.length === 0) {
      els.list.style.display = 'none';
      els.empty.style.display = 'block';

      if (currentFilter === 'upcoming') {
        els.emptyTitle.textContent = "No Upcoming Events";
        els.emptyDesc.textContent = "You don't have any events scheduled for the future.";
      } else {
        els.emptyTitle.textContent = "No Past Events";
        els.emptyDesc.textContent = "You haven't hosted any events yet.";
      }
      return;
    }

    els.empty.style.display = 'none';
    els.list.style.display = 'grid';
    els.list.innerHTML = filtered.map(createEventCard).join('');
  }

  function createEventCard(event) {
    const fallback = "https://placehold.co/600x400/1e293b/475569?text=No+Image";
    const imgUrl = event.image_url || fallback;
    const venueName = event.venue ? event.venue.name : 'Venue TBA';

    // --- NEW: Date Formatting Logic ---
    const start = new Date(event.start_datetime);
    const end = new Date(event.end_datetime);

    // Format: "6 Dec 2025"
    const dateStr = start.toLocaleDateString('en-SG', {
      day: 'numeric', month: 'short', year: 'numeric'
    });

    // Format: "06:00 pm"
    const timeOpts = { hour: '2-digit', minute: '2-digit', hour12: true };
    const startTime = start.toLocaleTimeString('en-SG', timeOpts).toLowerCase();
    const endTime = end.toLocaleTimeString('en-SG', timeOpts).toLowerCase();

    // Combine: "6 Dec 2025, 06:00 pm – 08:00 pm"
    const displayDate = `${dateStr}, ${startTime} – ${endTime}`;
    // ----------------------------------

    // Correct Link: use community_ prefix
    const detailUrl = `/event-detail?id=community_${event.id}`;

    const isPast = currentFilter === 'past';
    const badgeHtml = isPast
      ? `<span class="badge-float badge-past">Ended</span>`
      : `<span class="badge-float badge-community">Created by You</span>`;

    return `
        <div class="event-card">
            <a href="${detailUrl}" class="card-img-wrapper text-decoration-none">
                ${badgeHtml}
                <img src="${imgUrl}" alt="${escapeHtml(event.title)}" class="card-img" onerror="this.src='${fallback}'">
            </a>
            
            <div class="card-content">
                <a href="${detailUrl}" class="event-title text-truncate" title="${escapeHtml(event.title)}">
                    ${escapeHtml(event.title)}
                </a>
                
                <div class="event-meta">
                    <div><i class="bi bi-calendar3 text-primary"></i> ${displayDate}</div>
                    <div class="text-truncate"><i class="bi bi-geo-alt-fill text-danger"></i> ${escapeHtml(venueName)}</div>
                </div>

                <div class="event-actions">
                    <a href="${detailUrl}" class="btn btn-outline-info btn-sm">
                        <i class="bi bi-eye"></i> View
                    </a>
                    <button class="btn btn-outline-light btn-sm flex-grow-1" onclick="handleEdit('${event.id}')">
                        <i class="bi bi-pencil-square me-1"></i> Edit
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="handleDelete('${event.id}')">
                        <i class="bi bi-trash3"></i>
                    </button>
                </div>
            </div>
        </div>
        `;
  }

  // --- Actions ---

  window.handleEdit = (eventId) => {
    sessionStorage.setItem('editEventId', eventId);
    window.location.href = '/event-edit';
  };

  window.handleDelete = async (eventId) => {
    if (!confirm('Are you sure you want to delete this event? This cannot be undone.')) return;

    try {
      const res = await fetch(`${API_BASE}/events/${eventId}`, {
        method: 'DELETE',
        credentials: 'include'
      });

      if (res.ok) {
        // Reload: Refetch to get updated list
        loadEvents();
      } else {
        const data = await res.json();
        alert(data.error || 'Failed to delete event');
      }
    } catch (err) {
      console.error(err);
      alert('Network error. Could not delete event.');
    }
  };

  function showError(msg) {
    els.loading.style.display = 'none';
    els.list.style.display = 'none';
    els.empty.style.display = 'none';
    els.error.style.display = 'block';
    els.errorMsg.textContent = msg;
  }

  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>
{% endblock %}