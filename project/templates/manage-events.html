{% extends "base.html" %}
{% block title %}Manage Events â€” Event Calendar{% endblock %}

{% block content %}
<style>
    /* --- Page Specific Styles --- */
    
    /* Grid Layout */
    .events-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
    }

    /* Event Card Styling (Matching Index/Bookmarks) */
    .event-card {
        background-color: #1e293b;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        height: 100%;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .event-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.4);
        border-color: rgba(59, 130, 246, 0.5);
    }

    .card-img-wrapper {
        position: relative;
        height: 180px;
        width: 100%;
        background-color: #0f172a;
    }

    .card-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .badge-float {
        position: absolute;
        top: 12px;
        right: 12px;
        font-size: 0.7rem;
        font-weight: 700;
        padding: 4px 10px;
        border-radius: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        z-index: 2;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .badge-community { background-color: #4ade80; color: #0f172a; }

    .card-content {
        padding: 1.25rem;
        display: flex;
        flex-direction: column;
        flex-grow: 1;
    }

    .event-title {
        font-size: 1.15rem;
        font-weight: 700;
        color: #fff;
        margin-bottom: 0.75rem;
        line-height: 1.4;
    }

    .event-meta {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        font-size: 0.9rem;
        color: #94a3b8;
        margin-bottom: 1rem;
    }

    .event-meta i {
        width: 20px;
        text-align: center;
        margin-right: 6px;
    }

    .event-actions {
        margin-top: auto;
        padding-top: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        display: flex;
        gap: 0.75rem;
    }

    /* Empty State */
    .empty-state-icon {
        font-size: 4rem;
        color: #334155;
        margin-bottom: 1rem;
    }
</style>

<div class="container py-5">
    
    <div class="row mb-5">
        <div class="col-12 text-center">
            <h2 class="fw-bold text-white mb-2">Manage Your Events</h2>
            <p class="text-gray-400">View, edit, or delete the events you have created.</p>
            <a href="{{ url_for('main.event_new') }}" class="btn btn-primary rounded-pill px-4 fw-bold mt-3 shadow-sm">
                <i class="bi bi-plus-lg me-2"></i>Create New Event
            </a>
        </div>
    </div>

    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3 text-gray-400">Loading your events...</p>
    </div>

    <div id="empty-state" class="text-center py-5" style="display: none;">
        <div class="empty-state-icon">
            <i class="bi bi-calendar-x"></i>
        </div>
        <h4 class="text-white">No Events Created Yet</h4>
        <p class="text-gray-400 mb-4">You haven't posted any events to the community yet.</p>
        <a href="{{ url_for('main.event_new') }}" class="btn btn-outline-light rounded-pill px-4">Create Your First Event</a>
    </div>

    <div id="error-state" class="text-center py-5" style="display: none;">
        <div class="text-danger mb-3"><i class="bi bi-exclamation-circle display-4"></i></div>
        <h5 class="text-white">Something went wrong</h5>
        <p id="error-message" class="text-gray-400"></p>
        <button class="btn btn-outline-light btn-sm mt-2" onclick="location.reload()">Try Again</button>
    </div>

    <div id="events-list" class="events-grid" style="display: none;"></div>

</div>
{% endblock %}

{% block scripts %}
<script type="module">
    const API_BASE = window.API_BASE || '/api';

    // DOM Elements
    const els = {
        loading: document.getElementById('loading'),
        empty: document.getElementById('empty-state'),
        error: document.getElementById('error-state'),
        errorMsg: document.getElementById('error-message'),
        list: document.getElementById('events-list')
    };

    document.addEventListener('DOMContentLoaded', loadEvents);

    async function loadEvents() {
        try {
            const res = await fetch(`${API_BASE}/events/my-events`, {
                credentials: 'include'
            });

            if (!res.ok) {
                if(res.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                throw new Error('Failed to fetch events');
            }

            const events = await res.json();
            renderEvents(events);

        } catch (err) {
            console.error(err);
            showError('Failed to load your events. Please check your connection.');
        }
    }

    function renderEvents(events) {
        // Hide Loading
        els.loading.style.display = 'none';

        if (events.length === 0) {
            els.empty.style.display = 'block';
            els.list.style.display = 'none';
            return;
        }

        els.empty.style.display = 'none';
        els.list.style.display = 'grid'; // Enable Grid
        els.list.innerHTML = events.map(createEventCard).join('');
    }

    function createEventCard(event) {
        const fallback = "https://placehold.co/600x400/1e293b/475569?text=No+Image";
        const imgUrl = event.image_url || fallback;
        const date = new Date(event.start_datetime).toLocaleDateString('en-SG', {
            year: 'numeric', month: 'short', day: 'numeric', 
            hour: '2-digit', minute: '2-digit'
        });
        const venueName = event.venue ? event.venue.name : 'Venue TBA';

        return `
        <div class="event-card">
            <div class="card-img-wrapper">
                <span class="badge-float badge-community">Created by You</span>
                <img src="${imgUrl}" alt="${escapeHtml(event.title)}" class="card-img" onerror="this.src='${fallback}'">
            </div>
            
            <div class="card-content">
                <h3 class="event-title text-truncate" title="${escapeHtml(event.title)}">
                    ${escapeHtml(event.title)}
                </h3>
                
                <div class="event-meta">
                    <div><i class="bi bi-calendar3 text-primary"></i> ${date}</div>
                    <div class="text-truncate"><i class="bi bi-geo-alt-fill text-danger"></i> ${escapeHtml(venueName)}</div>
                </div>

                <div class="event-actions">
                    <button class="btn btn-outline-light btn-sm flex-grow-1" onclick="handleEdit('${event.id}')">
                        <i class="bi bi-pencil-square me-1"></i> Edit
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="handleDelete('${event.id}')">
                        <i class="bi bi-trash3"></i>
                    </button>
                </div>
            </div>
        </div>
        `;
    }

    // --- Actions ---

    window.handleEdit = (eventId) => {
        sessionStorage.setItem('editEventId', eventId);
        window.location.href = '/event-edit';
    };

    window.handleDelete = async (eventId) => {
        if (!confirm('Are you sure you want to delete this event? This cannot be undone.')) return;

        try {
            const res = await fetch(`${API_BASE}/events/${eventId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (res.ok) {
                // Reload events to reflect changes
                loadEvents();
            } else {
                const data = await res.json();
                alert(data.error || 'Failed to delete event');
            }
        } catch (err) {
            console.error(err);
            alert('Network error. Could not delete event.');
        }
    };

    function showError(msg) {
        els.loading.style.display = 'none';
        els.list.style.display = 'none';
        els.empty.style.display = 'none';
        els.error.style.display = 'block';
        els.errorMsg.textContent = msg;
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}