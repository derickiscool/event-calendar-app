{% extends "base.html" %}
{% block title %}User Profile — Event Calendar{% endblock %}

{% block content %}
<div class="container py-5">
    
    <div class="card bg-dark border-secondary border-opacity-25 mb-4">
        <div class="card-body p-4 text-center text-md-start">
            <div class="d-flex flex-column flex-md-row align-items-center gap-4">
                <div class="position-relative">
                    <img id="profile-avatar" src="https://ui-avatars.com/api/?name=User&background=3b82f6&color=fff" 
                         class="rounded-circle border border-2 border-primary" 
                         style="width: 120px; height: 120px; object-fit: cover;">
                </div>
                
                <div class="flex-grow-1">
                    <h2 class="text-white fw-bold mb-1" id="profile-username">Loading...</h2>
                    <p class="text-secondary mb-3" id="profile-name">...</p>
                    
                    <div class="d-flex gap-3 justify-content-center justify-content-md-start">
                        <div class="bg-black bg-opacity-25 px-3 py-2 rounded-3 border border-secondary border-opacity-25">
                            <h5 class="text-white fw-bold m-0" id="stat-events">0</h5>
                            <small class="text-secondary" style="font-size: 0.75rem;">EVENTS HOSTED</small>
                        </div>
                        <div class="bg-black bg-opacity-25 px-3 py-2 rounded-3 border border-secondary border-opacity-25">
                            <h5 class="text-white fw-bold m-0" id="stat-reviews">0</h5>
                            <small class="text-secondary" style="font-size: 0.75rem;">REVIEWS</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-7">
            <h4 class="text-white fw-bold mb-3 border-bottom border-secondary border-opacity-25 pb-2">Hosted Events</h4>
            <div id="hosted-events-list" class="d-flex flex-column gap-3">
                <p class="text-secondary fst-italic">No events hosted yet.</p>
            </div>
        </div>

        <div class="col-lg-5">
            <h4 class="text-white fw-bold mb-3 border-bottom border-secondary border-opacity-25 pb-2">Recent Reviews</h4>
            <div id="reviews-list" class="d-flex flex-column gap-3">
                <p class="text-secondary fst-italic">No reviews written yet.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const API_BASE = '/api';
    // Get User ID from URL (e.g., /profile/public/5)
    // We need to add a Flask route to render this template first
    const pathParts = window.location.pathname.split('/');
    const userId = pathParts[pathParts.length - 1];

    document.addEventListener('DOMContentLoaded', loadPublicProfile);

    async function loadPublicProfile() {
        try {
            const res = await fetch(`${API_BASE}/profile/${userId}`);
            if(!res.ok) throw new Error('User not found');
            const data = await res.json();
            
            renderHeader(data);
            renderEvents(data.events);
            renderReviews(data.reviews);
        } catch(e) {
            console.error(e);
            document.querySelector('.container').innerHTML = `<div class="text-center py-5 text-danger"><h3>User not found</h3></div>`;
        }
    }

    function renderHeader(data) {
        const u = data.user;
        const p = data.profile;
        
        document.getElementById('profile-username').textContent = `@${u.username}`;
        document.getElementById('profile-name').textContent = p.fname ? `${p.fname} ${p.lname || ''}` : 'Community Member';
        
        if(p.avatar_url) {
            document.getElementById('profile-avatar').src = p.avatar_url;
        } else {
            const initial = u.username.charAt(0).toUpperCase();
            document.getElementById('profile-avatar').src = `https://ui-avatars.com/api/?name=${initial}&background=3b82f6&color=fff&size=128`;
        }

        document.getElementById('stat-events').textContent = data.stats.events_hosted;
        document.getElementById('stat-reviews').textContent = data.stats.reviews_written;
    }

    function renderEvents(events) {
        const container = document.getElementById('hosted-events-list');
        if(!events || events.length === 0) return;
        
        container.innerHTML = events.map(e => `
            <div class="card bg-dark border-secondary border-opacity-25 overflow-hidden">
                <div class="row g-0">
                    <div class="col-3">
                        <img src="${e.image_url || '/static/assets/images/default-event.svg'}" class="img-fluid h-100 object-fit-cover" style="min-height: 100px;">
                    </div>
                    <div class="col-9">
                        <div class="card-body py-2">
                            <h6 class="card-title text-white mb-1">
                                <a href="/event-detail?id=community_${e.id}" class="text-decoration-none text-white stretched-link">${escapeHtml(e.title)}</a>
                            </h6>
                            <p class="card-text text-secondary small mb-1"><i class="bi bi-calendar3 me-1"></i> ${new Date(e.start_datetime).toLocaleDateString()}</p>
                            <p class="card-text text-secondary small text-truncate">${escapeHtml(e.description || '')}</p>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function renderReviews(reviews) {
        const container = document.getElementById('reviews-list');
        if(!reviews || reviews.length === 0) return;

        container.innerHTML = reviews.map(r => `
            <div class="card bg-dark border-secondary border-opacity-25 p-3">
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-warning small">${'★'.repeat(r.score)}${'☆'.repeat(5-r.score)}</span>
                    <small class="text-secondary">${new Date(r.created_at).toLocaleDateString()}</small>
                </div>
                <h6 class="text-white fw-bold mb-1">${escapeHtml(r.title || 'Review')}</h6>
                <p class="text-secondary small mb-0">"${escapeHtml(r.body)}"</p>
                <div class="mt-2 pt-2 border-top border-secondary border-opacity-10">
                    <a href="/event-detail?id=${r.event_identifier}" class="text-decoration-none small text-primary">View Event <i class="bi bi-arrow-right"></i></a>
                </div>
            </div>
        `).join('');
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}