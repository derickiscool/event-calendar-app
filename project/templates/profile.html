
{% extends "base.html" %}
{% block title %}Profile Settings — Event Calendar{% endblock %}

{% block content %}
<style>
    /* --- DASHBOARD STYLES --- */
    .profile-sidebar-card {
        background: #1e293b;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        text-align: center;
        padding: 2rem;
    }

    .profile-main-card {
        background: #1e293b;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 2rem;
    }

    /* Avatar Styling */
    .avatar-wrapper {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto 1.5rem;
    }

    .profile-avatar-lg {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
        border: 4px solid #0f172a;
        box-shadow: 0 0 0 2px #3b82f6;
    }

    .avatar-upload-btn {
        position: absolute;
        bottom: 0;
        right: 0;
        background: #3b82f6;
        color: white;
        border: 2px solid #0f172a;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .avatar-upload-btn:hover {
        transform: scale(1.1);
        background: #2563eb;
    }

    /* Form Styles */
    .form-label-custom {
        color: #94a3b8;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-control-dark {
        background-color: #0f172a;
        border: 1px solid #334155;
        color: #e2e8f0;
        padding: 0.75rem 1rem;
    }

    .form-control-dark:focus {
        background-color: #0f172a;
        border-color: #3b82f6;
        color: #fff;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    /* Tag Pills */
    .tag-pill {
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid #334155;
        background: #0f172a;
        color: #94a3b8;
        padding: 8px 16px;
        border-radius: 50px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        user-select: none;
    }

    .tag-pill:hover {
        border-color: #475569;
        color: #e2e8f0;
    }

    .tag-pill.active {
        background: rgba(59, 130, 246, 0.15);
        border-color: #3b82f6;
        color: #60a5fa;
    }
</style>

<div class="container py-5">
    <div class="row g-4">

        <div class="col-lg-4">
            <div class="profile-sidebar-card h-100">
                <div class="avatar-wrapper">
                    <img id="display-avatar" src="https://ui-avatars.com/api/?name=User&background=3b82f6&color=fff"
                        alt="Profile" class="profile-avatar-lg">

                    <label for="avatar-input" class="avatar-upload-btn" title="Change Photo">
                        <i class="bi bi-camera-fill small"></i>
                    </label>
                </div>

                <h3 id="display-username" class="text-white fw-bold mb-1">...</h3>
                <p id="display-email" class="text-secondary small mb-4">...</p>

                <div class="d-grid gap-2">
                    <button class="btn btn-outline-danger btn-sm" onclick="handleDeleteAccount()">
                        <i class="bi bi-trash3 me-2"></i> Delete Account
                    </button>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="profile-main-card">
                <h4 class="text-white fw-bold mb-4 border-bottom border-secondary pb-3 border-opacity-25">Profile
                    Details</h4>

                <form id="profile-form">

                    <input type="file" id="avatar-input" name="avatar" accept="image/*" style="display: none;">

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label-custom">First Name</label>
                            <input type="text" class="form-control form-control-dark rounded-3" id="fname" name="fname">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-custom">Last Name</label>
                            <input type="text" class="form-control form-control-dark rounded-3" id="lname" name="lname">
                        </div>

                        <div class="col-md-6">
                            <label class="form-label-custom">Phone Number</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark border-secondary text-secondary">+65</span>
                                <input type="tel" class="form-control form-control-dark" id="phone" name="phone"
                                    maxlength="8" placeholder="81234567">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-custom">Postal Code</label>
                            <input type="text" class="form-control form-control-dark rounded-3" id="postal"
                                name="postal_code" maxlength="6">
                        </div>
                    </div>

                    <div class="mt-5">
                        <h5 class="text-white fw-bold mb-3">Event Preferences</h5>
                        <p class="text-secondary small mb-3">Select the categories you want to see on your home feed.
                        </p>

                        <div id="tags-container" class="d-flex flex-wrap gap-2">
                            <span class="text-muted small">Loading tags...</span>
                        </div>
                    </div>

                    <div
                        class="mt-5 pt-3 border-top border-secondary border-opacity-25 d-flex justify-content-end gap-3">
                        <button type="button" class="btn btn-outline-light rounded-pill px-4"
                            onclick="window.location.reload()">Cancel</button>
                        <button type="submit" class="btn btn-primary rounded-pill px-5 fw-bold" id="save-btn">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive"
        aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toast-message">Update successful</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const API_BASE = '/api';
    let userTags = [];
    let allTags = [];

    document.addEventListener('DOMContentLoaded', async () => {
        await loadProfile();
        await loadPreferences();
    });

    // --- 1. LOAD PROFILE ---
    async function loadProfile() {
        try {
            const res = await fetch(`${API_BASE}/profile/me`);
            if (!res.ok) throw new Error('Failed to load');
            const data = await res.json();

            const u = data.user;
            const p = data.profile;

            // Identity Sidebar
            document.getElementById('display-username').textContent = u.username || 'User';
            document.getElementById('display-email').textContent = u.email || '';

            // Avatar Logic
            if (p.avatar_url) {
                document.getElementById('display-avatar').src = p.avatar_url;
            } else {
                const initial = (u.username || 'U').charAt(0).toUpperCase();
                document.getElementById('display-avatar').src = `https://ui-avatars.com/api/?name=${initial}&background=3b82f6&color=fff&size=128`;
            }

            // Form Fields
            document.getElementById('fname').value = p.fname || '';
            document.getElementById('lname').value = p.lname || '';
            document.getElementById('phone').value = p.phone || '';
            document.getElementById('postal').value = p.postal_code || '';

        } catch (e) { console.error("Profile load error:", e); }
    }

    // --- 2. PREFERENCES (Tags) ---
    async function loadPreferences() {
        try {
            const resMe = await fetch(`${API_BASE}/preferences/me`);
            if (resMe.ok) {
                const data = await resMe.json();
                userTags = data.preferences.map(p => p.tag_id);
            }

            const resAll = await fetch(`${API_BASE}/tags`);
            if (resAll.ok) {
                const data = await resAll.json();
                allTags = data; 
                renderTags();
            }
        } catch (e) { console.error("Tags error:", e); }
    }

    function renderTags() {
        const container = document.getElementById('tags-container');
        container.innerHTML = '';

        allTags.forEach(tag => {
            const isActive = userTags.includes(tag.id);
            const tagName = tag.tag_name || tag.name || 'Tag';

            const pill = document.createElement('div');
            pill.className = `tag-pill ${isActive ? 'active' : ''}`;
            pill.innerHTML = `<span>${tagName}</span>`;
            if (isActive) pill.innerHTML += '<i class="bi bi-check-circle-fill small"></i>';

            pill.onclick = () => toggleTag(tag.id, pill);
            container.appendChild(pill);
        });
    }

    // --- 3. INTERACTIONS ---

    async function toggleTag(tagId, element) {
        const isAdding = !element.classList.contains('active');
        const method = isAdding ? 'POST' : 'DELETE';
        // Handle URL differences: DELETE uses ID in URL, POST uses body
        const url = isAdding ? `${API_BASE}/preferences/me` : `${API_BASE}/preferences/me/${tagId}`;
        const options = { method: method };
        
        if (isAdding) {
            options.headers = { 'Content-Type': 'application/json' };
            options.body = JSON.stringify({ tag_id: tagId });
        }

        try {
            element.classList.toggle('active');
            const spanText = element.querySelector('span').innerText;
            if (isAdding) element.innerHTML = `<span>${spanText}</span><i class="bi bi-check-circle-fill small"></i>`;
            else element.innerHTML = `<span>${spanText}</span>`;

            const res = await fetch(url, options);
            if (!res.ok) throw new Error();
        } catch (e) {
            element.classList.toggle('active'); // Revert
            showToast('Failed to update preference', 'text-bg-danger');
        }
    }

    document.getElementById('avatar-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('display-avatar').src = e.target.result;
                showToast('Image selected. Click "Save Changes" to apply.', 'text-bg-info');
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('save-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

        const formData = new FormData(e.target);

        try {
            const res = await fetch(`${API_BASE}/profile/me`, {
                method: 'PUT',
                body: formData
            });

            const data = await res.json();

            if (res.ok) {
                showToast('Profile updated successfully!', 'text-bg-success');
                
                // Navbar Avatar Update
                const navImg = document.getElementById('nav-user-img');
                const navInitial = document.getElementById('nav-user-initial');
                const newAvatarUrl = data.profile.avatar_url;

                if (newAvatarUrl) {
                    if (navImg) {
                        navImg.src = newAvatarUrl + '?t=' + new Date().getTime();
                    } else if (navInitial) {
                        window.location.reload();
                        return;
                    }
                }
                
                await loadProfile();
            } else {
                showToast(data.error || 'Update failed', 'text-bg-danger');
            }
        } catch (e) {
            console.error(e);
            showToast('Server error', 'text-bg-danger');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Save Changes';
        }
    });

    // --- DELETE ACCOUNT FUNCTION ---
    window.handleDeleteAccount = async function() {
        const confirmMsg = "WARNING: This cannot be undone!\n\nDeleting your account will remove:\n• Your profile\n• All events you created\n• All reviews and bookmarks\n\nAre you absolutely sure?";
        
        if (!confirm(confirmMsg)) return;
        
        const doubleCheck = confirm("Final Confirmation: Delete account permanently?");
        if (!doubleCheck) return;

        try {
            const res = await fetch(`${API_BASE}/delete-account`, {
                method: 'DELETE',
                credentials: 'include'
            });

            const data = await res.json();

            if (res.ok) {
                alert('Account deleted. Redirecting to home...');
                window.location.href = '/';
            } else {
                alert(data.message || 'Failed to delete account');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Network error occurred.');
        }
    };

    function showToast(msg, bgClass) {
        const el = document.getElementById('liveToast');
        document.getElementById('toast-message').textContent = msg;
        el.className = `toast align-items-center border-0 ${bgClass}`;
        new bootstrap.Toast(el).show();
    }
</script>
{% endblock %}
